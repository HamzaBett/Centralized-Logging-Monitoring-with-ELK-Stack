# Filebeat Configuration
filebeat.autodiscover:
  providers:
    - type: docker
      templates:
        - condition:
            contains:
              docker.container.image: "app"
          config:
            - type: container
              paths:
                - /var/lib/docker/containers/${data.docker.container.id}/*.log
              processors:
                - add_docker_metadata: ~
                - decode_json_fields:
                    fields: ["message"]
                    process_escaped_values: true
                - add_fields:
                    target: ''
                    fields:
                      service_name: "${data.container.name}"
                      environment: "production"
                      version: "1.0.0"
                - add_host_metadata:
                    netinfo.enabled: true
                - timestamp:
                    field: 'timestamp'
                    layouts:
                      - '2006-01-02T15:04:05.000Z'

# Multiline configuration for stack traces
filebeat.inputs:
  - type: container
    paths:
      - /var/lib/docker/containers/*/*.log
    processors:
      - add_docker_metadata: ~
    multiline.type: pattern
    multiline.pattern: '^\s+(at|\.{3})|[\\[({]'
    multiline.negate: false
    multiline.match: after

# Output configuration
output.logstash:
  hosts: ["logstash:5044"]
  ssl.certificate_authorities: ["${CERTIFICATE_AUTHORITIES}/ca.crt"]
  ssl.certificate: "${CERTIFICATE_AUTHORITIES}/filebeat/filebeat.crt"
  ssl.key: "${CERTIFICATE_AUTHORITIES}/filebeat/filebeat.key"
  ssl.key_passphrase: "${SSL_KEY_PASSPHRASE}"
  ssl.verification_mode: full

# Monitoring
monitoring.enabled: true
monitoring.elasticsearch.hosts: ${ELASTICSEARCH_HOSTS}
monitoring.elasticsearch.username: ${ELASTICSEARCH_USERNAME}
monitoring.elasticsearch.password: ${ELASTICSEARCH_PASSWORD}

# Logging
logging.level: ${LOG_LEVEL}
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644

# Queue settings
queue.mem.events: 4096
queue.mem.flush.min_events: 2048
queue.mem.flush.timeout: 5s
